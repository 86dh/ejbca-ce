Set up a database for EJBCA in JBoss
====================================

The following databases have in some stage been tested with EJBCA:

* Hypersoniq (hsqldb) (default in JBoss)
* PostegreSQL 7.2 (http://www.postgresql.org/)
* MySQL (http://www.mysql.com/)
* Oracle 8i (http://www.oracle.com/)
* Sybase

NOTE:

To use the default database, HypersonicDB, nothing should be done, just install
JBoss and run. Read this HOWTO if you want to replace the default database with
another.

Unless you are adventurous and know what you're doing, it is recommended to define
another datasource for ejbca and not reconfigure DefaultDS with another database
as you run the risk to jump into mapping bugs in the JBoss configuration and mess
up your server default configuration.

NOW ON TO THE HOWTO!

Troubleshooting database problems:
---------------------------------
* Have you configured a <database-ds.xml> in JBOSS_HOME/server/default/deploy?
* Do you have the correct username/password configured in <database-ds.xml>?
* Is the JDBC driver installed in JBOSS_HOME/server/default/lib?
* Does you database accept incoming connection from the network, not only localhost or vice versa?
* Do you have a firewall blocking connections to the database?
* Can you connect to the database from another machine?
* Use ip-address instead of hostname in <database-ds.xml> (DNS problems?)

Configuring EJBCA
-----------------

1. Use the command 'ant replaceDS'. 
This command replaces jbosscmp-jdbc.xml files and all occurences of 'java:/DefaultDS' 
ejb-jar.xml files.
JDBC files changed are: ('ant replaceDS' does ALL this for you)
src/ra/META-INF/jbosscmp-jdbc-<database>.xml
src/authorization/META-INF/jbosscmp-jdbc-<database>.xml
src/log/META-INF/jbosscmp-jdbc-<database>.xml
src/hardtoken/META-INF/jbosscmp-jdbc-<database>.xml
src/keyrecovery/META-INF/jbosscmp-jdbc-<database>.xml

2. Build and deploy EJBCA with 'ant deploy'.

Configuring JBoss
-----------------

The description given here is for JBoss 3.x. Consider consulting the
official JBoss documentation.

First comes the general description and in the end database specific
configurations are given in sections for the specific databases.

Database configuration files in JBoss is located in the
<jboss-home>/server/default/deploy.

1. Install and setup the database.

2. Create a database for EJBCA, for example 'ejbca'.

2. Put the JDBC driver for the database in <jboss-home>/server/default/lib/.

3. Copy the proper <database>-ds.xml file to <jboss-home>
/server/default/deploy. The JDBC-driver must be inluded and the database set up
as a datasource, like  EjbcaDS. Current <database>-ds.xml files can be obtained from
jboss.org, provided here are snapshots that work for me.

4. DONE! Start JBoss. Run tests with 'runtest.sh/cmd'.
   Use your favorite database graphic editor to look at the beautiful database tables.

MySQL specifics
---------------
Jaws configuration file: jbosscmp-jdbc-mysql.xml

JDBC driver: mysql-connector-java-3.0.x.jar (preferably 3.0.9 or higher).

Download JDBC driver for mySQL from http://www.mysql.com/

Copy mysql-ds.xml to server/default/deploy
In mysql-ds.xml is defined the databas instance (EJBCA), in the connection-URL,
and the database username (EJBCA) and password (EJBCA).
These must be changed to your values.
The item 'ConnectionURL' must be edited to match your database.

Type mapping (just a reference):

     <datasource>java:/EjbcaDS</datasource>
     <type-mapping>mySQL</type-mapping>

PostgreSQL specifics
--------------------
EJBCA have been tested with PostgreSQL 7.2, which is why the database mapping
"PostgreSQL 7.2" is beeing used. Other versions of PostgreSQL might be able to
use the mapping "PostgreSQL".

Jaws configuration file: jbosscmp-jdbc-postgres.xml

JDBC driver: the 7.4 driver (development) is needed to support the JDBC used by
JBoss.

Download JDBC driver for PostgreSQL from http://jdbc.postgresql.org/.

Copy postgres-ds.xml to server/default/deploy
In postgres-ds.xml is defined the databas instance (EJBCA), in the connection-URL, 
and the database username (EJBCA) and password (EJBCA).
These must be changed to your values.
The item 'ConnectionURL' must be edited to match your database.

Type mapping (just a reference):

     <datasource>java:/EjbcaDS</datasource>
     <type-mapping>PostgreSQL 7.2</type-mapping>

Oracle specifics
----------------
Jaws configuration file: jbosscmp-jdbc-oracle.xml
JBoss configuration file: oracle-service.xml

JDBC driver: classes12.zip (can be downloaded from http://www.oracle.com/).

Copy oracle-ds.xml to server/default/deploy
In oracle-ds.xml is defined the database instance (EJBCA), in the connection-URL, 
and the database username (EJBCA) and password (EJBCA). 
These must be changed to your values.
The item 'ConnectionURL' must be edited to match your database.

Type mapping (just a reference):

     <datasource>java:/EjbcaDS</datasource>
     <type-mapping>Oracle8</type-mapping>

MS-SQL specifics
----------------
Jaws configuration file: jbosscmp-jdbc-mssql2000.xml
JBoss configuration file: mssql-ds.xml

JDBC driver: http://msdn.microsoft.com/downloads/default.asp?url=/downloads/sample.asp?url=/MSDN-FILES/027/001/779/msdncompositedoc.xml&frame=true

Copy mssql-ds.xml to server/default/deploy
In mssql-ds.xml is defined the database instance (EJBCA), in the connection-URL, 
and the database username (EJBCA) and password (EJBCA). 
These must be changed to your values.
The item 'ConnectionURL' must be edited to match your database.

Type mapping (just a reference):

     <datasource>java:/EjbcaDS</datasource>
     <type-mapping>MS SQLSERVER2000</type-mapping>




